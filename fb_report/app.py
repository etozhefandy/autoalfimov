from datetime import datetime, timedelta, time

from telegram import (
    Update,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
    ReplyKeyboardRemove,
)
from telegram.error import BadRequest
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters,
)

from billing_watch import init_billing_watch

from .constants import (
    ALMATY_TZ,
    TELEGRAM_TOKEN,
    DEFAULT_REPORT_CHAT,
    ALLOWED_USER_IDS,
    ALLOWED_CHAT_IDS,
    usd_to_kzt,
    kzt_round_up_1000,
)
from .storage import (
    load_accounts,
    save_accounts,
    get_account_name,
    get_enabled_accounts_in_order,
    human_last_sync,
    upsert_from_bm,
)
from .reporting import (
    get_cached_report,
    build_comparison_report,
    send_period_report,
    parse_range,
    parse_two_ranges,
)
from .insights import build_heatmap_for_account
from .adsets import send_adset_report
from .billing import send_billing, send_billing_forecast, billing_digest_job
from .jobs import full_daily_scan_job, daily_report_job, schedule_cpa_alerts

# === –ê–í–¢–û–ü–ò–õ–ê–¢ ===
from autopilat.engine import get_recommendations_ui
from autopilat.ui import (
    autopilot_main_menu,
    autopilot_submode_menu,
    confirm_action_buttons,
)
from autopilat.actions import (
    apply_budget_change,
    disable_entity,
    parse_manual_input,
    can_disable,
)


# ============ PRIVACY ============
def _allowed(update: Update) -> bool:
    chat_id = str(update.effective_chat.id) if update.effective_chat else ""
    user_id = update.effective_user.id if update.effective_user else None
    if chat_id in ALLOWED_CHAT_IDS:
        return True
    if user_id and user_id in ALLOWED_USER_IDS:
        return True
    return False


# ======= SAFE EDIT =======
async def safe_edit_message(q, text: str, **kwargs):
    try:
        return await q.edit_message_text(text=text, **kwargs)
    except BadRequest as e:
        if "Message is not modified" in str(e):
            return
        raise


# ============ UI ============
def main_menu() -> InlineKeyboardMarkup:
    last_sync = human_last_sync()
    return InlineKeyboardMarkup(
        [
            [InlineKeyboardButton("–û—Ç—á—ë—Ç –ø–æ –≤—Å–µ–º", callback_data="rep_all_menu")],
            [InlineKeyboardButton("–ë–∏–ª–ª–∏–Ω–≥", callback_data="billing")],
            [
                InlineKeyboardButton(
                    "–û—Ç—á—ë—Ç –ø–æ –∞–∫–∫–∞—É–Ω—Ç—É", callback_data="choose_acc_report"
                )
            ],
            [
                InlineKeyboardButton("–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞", callback_data="hm_menu")
            ],
            [
                InlineKeyboardButton("–ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="choose_acc_settings")
            ],
            [
                InlineKeyboardButton("ü§ñ –ê–≤—Ç–æ–ø–∏–ª–∞—Ç", callback_data="ap_main")
            ],
            [
                InlineKeyboardButton(
                    f"–°–∏–Ω–∫ BM (–ø–æ—Å–ª. {last_sync})",
                    callback_data="sync_bm",
                )
            ],
        ]
    )


def billing_menu() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [
            [InlineKeyboardButton("–¢–µ–∫—É—â–∏–µ –±–∏–ª–ª–∏–Ω–≥–∏", callback_data="billing_current")],
            [InlineKeyboardButton("–ü—Ä–æ–≥–Ω–æ–∑ —Å–ø–∏—Å–∞–Ω–∏–π", callback_data="billing_forecast")],
            [InlineKeyboardButton("‚¨ÖÔ∏è –í –º–µ–Ω—é", callback_data="menu")],
        ]
    )


def all_reports_menu() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [
            [
                InlineKeyboardButton("–°–µ–≥–æ–¥–Ω—è", callback_data="rep_today"),
                InlineKeyboardButton("–í—á–µ—Ä–∞", callback_data="rep_yday"),
            ],
            [InlineKeyboardButton("–ü—Ä–æ—à–µ–¥—à–∞—è –Ω–µ–¥–µ–ª—è", callback_data="rep_week")],
            [InlineKeyboardButton("‚¨ÖÔ∏è –í –º–µ–Ω—é", callback_data="menu")],
        ]
    )


def heatmap_menu(aid: str) -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [
            [
                InlineKeyboardButton("7 –¥–Ω–µ–π", callback_data=f"hm7|{aid}"),
                InlineKeyboardButton("14 –¥–Ω–µ–π", callback_data=f"hm14|{aid}"),
            ],
            [
                InlineKeyboardButton(
                    "–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü", callback_data=f"hmmonth|{aid}"
                )
            ],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="menu")],
        ]
    )


def _flag_line(aid: str) -> str:
    st = load_accounts().get(aid, {})
    enabled = st.get("enabled", True)
    m = st.get("metrics", {}) or {}
    a = st.get("alerts", {}) or {}
    on = "üü¢" if enabled else "üî¥"
    mm = "üí¨" if m.get("messaging") else ""
    ll = "‚ôøÔ∏è" if m.get("leads") else ""
    aa = "‚ö†Ô∏è" if a.get("enabled") and (a.get("target_cpl", 0) or 0) > 0 else ""
    return f"{on} {mm}{ll}{aa}".strip()


def accounts_kb(prefix: str) -> InlineKeyboardMarkup:
    store = load_accounts()
    if store:
        enabled_ids = [aid for aid, row in store.items() if row.get("enabled", True)]
        disabled_ids = [aid for aid, row in store.items() if not row.get("enabled", True)]
        ids = enabled_ids + disabled_ids
    else:
        from .constants import AD_ACCOUNTS_FALLBACK

        ids = AD_ACCOUNTS_FALLBACK

    rows = []
    for aid in ids:
        rows.append(
            [
                InlineKeyboardButton(
                    f"{_flag_line(aid)}  {get_account_name(aid)}",
                    callback_data=f"{prefix}|{aid}",
                )
            ]
        )
    rows.append([InlineKeyboardButton("‚¨ÖÔ∏è –í –º–µ–Ω—é", callback_data="menu")])
    return InlineKeyboardMarkup(rows)


def settings_kb(aid: str) -> InlineKeyboardMarkup:
    st = load_accounts().get(aid, {"enabled": True, "metrics": {}, "alerts": {}})
    en_text = "–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç" if st.get("enabled", True) else "–í–∫–ª—é—á–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç"
    m_on = st.get("metrics", {}).get("messaging", True)
    l_on = st.get("metrics", {}).get("leads", False)
    a_on = st.get("alerts", {}).get("enabled", False) and (
        st.get("alerts", {}).get("target_cpl", 0) or 0
    ) > 0
    return InlineKeyboardMarkup(
        [
            [InlineKeyboardButton(en_text, callback_data=f"toggle_enabled|{aid}")],
            [
                InlineKeyboardButton(
                    f"üí¨ –ü–µ—Ä–µ–ø–∏—Å–∫–∏: {'ON' if m_on else 'OFF'}",
                    callback_data=f"toggle_m|{aid}",
                ),
                InlineKeyboardButton(
                    f"‚ôøÔ∏è –õ–∏–¥—ã —Å–∞–π—Ç–∞: {'ON' if l_on else 'OFF'}",
                    callback_data=f"toggle_l|{aid}",
                ),
            ],
            [
                InlineKeyboardButton(
                    f"‚ö†Ô∏è –ê–ª–µ—Ä—Ç CPA: {'ON' if a_on else 'OFF'}",
                    callback_data=f"toggle_alert|{aid}",
                )
            ],
            [
                InlineKeyboardButton(
                    "‚úèÔ∏è –ó–∞–¥–∞—Ç—å target CPA", callback_data=f"set_cpa|{aid}"
                )
            ],
            [
                InlineKeyboardButton(
                    "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É",
                    callback_data="choose_acc_settings",
                )
            ],
        ]
    )


def period_kb_for(aid: str) -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [
            [
                InlineKeyboardButton("–°–µ–≥–æ–¥–Ω—è", callback_data=f"one_today|{aid}"),
                InlineKeyboardButton("–í—á–µ—Ä–∞", callback_data=f"one_yday|{aid}"),
            ],
            [InlineKeyboardButton("–ü—Ä–æ—à–µ–¥—à–∞—è –Ω–µ–¥–µ–ª—è", callback_data=f"one_week|{aid}")],
            [
                InlineKeyboardButton(
                    "–°—Ä–∞–≤–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥—ã", callback_data=f"cmp_menu|{aid}"
                )
            ],
            [
                InlineKeyboardButton(
                    "üóì –°–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω", callback_data=f"one_custom|{aid}"
                )
            ],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ö –∞–∫–∫–∞—É–Ω—Ç–∞–º", callback_data="choose_acc_report")],
        ]
    )


def compare_kb_for(aid: str) -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [
            [
                InlineKeyboardButton(
                    "–≠—Ç–∞ –Ω–µ–¥–µ–ª—è vs –ø—Ä–æ—à–ª–∞—è", callback_data=f"cmp_week|{aid}"
                )
            ],
            [
                InlineKeyboardButton(
                    "–î–≤–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞", callback_data=f"cmp_custom|{aid}"
                )
            ],
            [
                InlineKeyboardButton(
                    "‚¨ÖÔ∏è –ö –ø–µ—Ä–∏–æ–¥–∞–º", callback_data=f"back_periods|{aid}"
                )
            ],
        ]
    )


def account_report_kind_kb(aid: str) -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [
            [
                InlineKeyboardButton(
                    "–û—Ç—á—ë—Ç –ø–æ –∞–∫–∫–∞—É–Ω—Ç—É", callback_data=f"rep_acc|{aid}"
                )
            ],
            [
                InlineKeyboardButton(
                    "–û—Ç—á—ë—Ç –ø–æ –∞–¥—Å–µ—Ç–∞–º", callback_data=f"rep_adsets|{aid}"
                )
            ],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ö –∞–∫–∫–∞—É–Ω—Ç–∞–º", callback_data="choose_acc_report")],
        ]
    )


# ======== COMMANDS ============
async def cmd_whoami(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id if update.effective_chat else None
    user_id = update.effective_user.id if update.effective_user else None
    await update.message.reply_text(
        f"user_id: <code>{user_id}</code>\nchat_id: <code>{chat_id}</code>",
        parse_mode="HTML",
    )


async def cmd_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not _allowed(update):
        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text=(
                "‚õîÔ∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –û—Ç–ø—Ä–∞–≤—å /whoami –∏ –¥–æ–±–∞–≤—å —Å–≤–æ–π user_id "
                "–≤ ALLOWED_USER_IDS."
            ),
        )
        return
    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="ü§ñ –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=main_menu(),
    )


async def cmd_help(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not _allowed(update):
        return
    txt = (
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start ‚Äî –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "/help ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥\n"
        "/billing ‚Äî –±–∏–ª–ª–∏–Ω–≥–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã\n"
        "/sync_accounts ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è BM\n"
        "/whoami ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å user_id/chat_id\n"
        "/heatmap <act_id> ‚Äî —Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∞–¥—Å–µ—Ç–æ–≤ –∑–∞ 7 –¥–Ω–µ–π\n"
        "\n"
        "üöÄ –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ–ø–∏–ª–∞—Ç–∞:\n"
        "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∞–∫–∫–∞—É–Ω—Ç—É\n"
        "‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ (-20%, +20%, —Ä—É—á–Ω–æ–π –≤–≤–æ–¥)\n"
        "‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –¥–æ—Ä–æ–≥–∏—Ö –∞–¥—Å–µ—Ç–æ–≤\n"
        "‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ò–ò-—É–ø—Ä–∞–≤–ª–µ–Ω–∏—é (–ü–∏–ª–∞—Ç)\n"
    )
    await update.message.reply_text(txt, reply_markup=ReplyKeyboardRemove())


async def cmd_billing(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not _allowed(update):
        return
    await update.message.reply_text(
        "–ß—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ –±–∏–ª–ª–∏–Ω–≥—É?", reply_markup=billing_menu()
    )


async def cmd_heatmap(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not _allowed(update):
        return

    parts = update.message.text.strip().split()

    if len(parts) == 1:
        await update.message.reply_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:",
            reply_markup=accounts_kb("hmacc"),
        )
        return

    aid = parts[1].strip()
    if not aid.startswith("act_"):
        aid = "act_" + aid

    context.user_data["heatmap_aid"] = aid

    await update.message.reply_text(
        f"–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –¥–ª—è {get_account_name(aid)}:",
        reply_markup=heatmap_menu(aid),
    )


async def cmd_sync(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not _allowed(update):
        return
    try:
        res = upsert_from_bm()
        last_sync_h = human_last_sync()
        await update.message.reply_text(
            f"‚úÖ –°–∏–Ω–∫ –∑–∞–≤–µ—Ä—à—ë–Ω. –î–æ–±–∞–≤–ª–µ–Ω–æ: {res['added']}, "
            f"–æ–±–Ω–æ–≤–ª–µ–Ω–æ: {res['updated']}, –ø—Ä–æ–ø—É—â–µ–Ω–æ: {res['skipped']}. "
            f"–í—Å–µ–≥–æ: {res['total']}\n"
            f"üïì –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: {last_sync_h}"
        )
    except Exception as e:
        await update.message.reply_text(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω–∫–∞: {e}")


# ============ CALLBACKS –î–õ–Ø –ê–í–¢–û–ü–ò–õ–ê–¢–ê ============
async def on_cb_autopilot(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()

    if not _allowed(update):
        await q.edit_message_text("‚õîÔ∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.")
        return

    data = q.data or ""
    chat_id = str(q.message.chat.id)

    if data == "ap_main":
        await q.edit_message_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∞–≤—Ç–æ–ø–∏–ª–∞—Ç–∞:",
            reply_markup=autopilot_main_menu()
        )
        return

    if data.startswith("apmode|"):
        mode = data.split("|", 1)[1]
        context.user_data["autopilot_mode"] = mode

        await q.edit_message_text(
            f"–†–µ–∂–∏–º: <b>{mode}</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–µ–∂–∏–º:",
            parse_mode="HTML",
            reply_markup=autopilot_submode_menu()
        )
        return

    if data.startswith("apsub|"):
        sub = data.split("|", 1)[1]
        context.user_data["autopilot_submode"] = sub

        await q.edit_message_text(
            f"–†–µ–∂–∏–º: <b>{context.user_data.get('autopilot_mode')}</b>\n"
            f"–ü–æ–¥—Ä–µ–∂–∏–º: <b>{sub}</b>\n\n"
            f"–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç:",
            parse_mode="HTML",
            reply_markup=accounts_kb("ap_acc")
        )
        return

    if data.startswith("ap_acc|"):
        aid = data.split("|", 1)[1]
        context.user_data["ap_aid"] = aid

        ui = get_recommendations_ui(aid)
        text = f"üîç <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ {get_account_name(aid)}</b>\n\n{ui['text']}"
        await q.edit_message_text(text, parse_mode="HTML")

        from autopilat.ui import build_recommendations_ui

        blocks = build_recommendations_ui(ui["items"])
        for block in blocks:
            await context.bot.send_message(
                chat_id,
                block["text"],
                parse_mode="HTML",
                reply_markup=block["reply_markup"]
            )
        return

    if data.startswith("ap|"):
        parts = data.split("|")
        if len(parts) < 2:
            await q.edit_message_text(
                "‚ö† –û—à–∏–±–∫–∞ –∫–Ω–æ–ø–∫–∏: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback_data.",
                parse_mode="HTML",
            )
            return

        _, action, *rest = parts
        entity_id = rest[0] if rest else ""

        if action == "back":
            await q.edit_message_text(
                "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∞–≤—Ç–æ–ø–∏–ª–∞—Ç–∞:",
                reply_markup=autopilot_main_menu(),
            )
            return

        if not entity_id:
            await q.edit_message_text(
                "‚ö† –û—à–∏–±–∫–∞ –∫–Ω–æ–ø–∫–∏: –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω ID —Å—É—â–Ω–æ—Å—Ç–∏.\n"
                "–û–±–Ω–æ–≤–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.",
                parse_mode="HTML",
            )
            return

        if action == "manual":
            context.user_data["await_manual_input"] = entity_id
            await q.edit_message_text(
                f"‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.2, -20, 15):\n"
                f"ID: <code>{entity_id}</code>",
                parse_mode="HTML",
            )
            return

        await q.edit_message_text(
            f"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ <b>{action}</b> –¥–ª—è <code>{entity_id}</code>?",
            parse_mode="HTML",
            reply_markup=confirm_action_buttons(action, entity_id),
        )
        return

    if data.startswith("apconfirm|"):
        _, yesno, action, entity_id = data.split("|", 3)

        if yesno == "no":
            await q.edit_message_text("–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.", parse_mode="HTML")
            return

        if action in ("up20", "down20"):
            percent = 20 if action == "up20" else -20
            res = apply_budget_change(entity_id, percent)
            await q.edit_message_text(res["message"], parse_mode="HTML")
            return

        if action == "off":
            aid = context.user_data.get("ap_aid")
            if aid and not can_disable(aid, entity_id):
                await q.edit_message_text(
                    "‚ùå –ù–µ–ª—å–∑—è –æ—Ç–∫–ª—é—á–∏—Ç—å —ç—Ç–æ—Ç –∞–¥—Å–µ—Ç ‚Äî –∏–Ω–∞—á–µ –≤–µ—Å—å –∞–∫–∫–∞—É–Ω—Ç –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –±–µ–∑ —Ç—Ä–∞—Ñ–∏–∫–∞.",
                    parse_mode="HTML"
                )
                return

            res = disable_entity(entity_id)
            await q.edit_message_text(res["message"], parse_mode="HTML")
            return

        try:
            percent = float(action.replace(",", "."))
        except Exception:
            await q.edit_message_text(
                "‚ö† –ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è.",
                parse_mode="HTML"
            )
            return

        res = apply_budget_change(entity_id, percent)
        await q.edit_message_text(res["message"], parse_mode="HTML")
        return


# ============ –û–ë–©–ò–ï CALLBACK'–∏ ============
async def on_cb(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()
    if not _allowed(update):
        await q.edit_message_text("‚õîÔ∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.")
        return

    data = q.data or ""
    chat_id = str(q.message.chat.id)

    if data == "menu":
        await q.edit_message_text("ü§ñ –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=main_menu())
        return

    if data == "rep_all_menu":
        await q.edit_message_text("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:", reply_markup=all_reports_menu())
        return

    # ===== –û–¢–ß–Å–¢ –ü–û –ê–î–°–ï–¢–ê–ú (–∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é) =====
    if data == "adsets_menu":
        await q.edit_message_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –æ—Ç—á—ë—Ç–∞ –ø–æ –∞–¥—Å–µ—Ç–∞–º:",
            reply_markup=accounts_kb("adrep"),
        )
        return

    if data.startswith("adrep|"):
        aid = data.split("|", 1)[1]
        await q.edit_message_text(
            f"–ì–æ—Ç–æ–≤–ª—é –æ—Ç—á—ë—Ç –ø–æ –∞–¥—Å–µ—Ç–∞–º –¥–ª—è {get_account_name(aid)} "
            f"–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π‚Ä¶"
        )
        await send_adset_report(context, chat_id, aid)
        return

    # ===== –û–ë–©–ò–ï –û–¢–ß–Å–¢–´ =====
    if data == "rep_today":
        label = datetime.now(ALMATY_TZ).strftime("%d.%m.%Y")
        await q.edit_message_text(f"–ì–æ—Ç–æ–≤–ª—é –æ—Ç—á—ë—Ç –∑–∞ {label}‚Ä¶")
        await send_period_report(context, chat_id, "today", label)
        return

    if data == "rep_yday":
        label = (datetime.now(ALMATY_TZ) - timedelta(days=1)).strftime("%d.%m.%Y")
        await q.edit_message_text(f"–ì–æ—Ç–æ–≤–ª—é –æ—Ç—á—ë—Ç –∑–∞ {label}‚Ä¶")
        await send_period_report(context, chat_id, "yesterday", label)
        return

    if data == "rep_week":
        until = datetime.now(ALMATY_TZ) - timedelta(days=1)
        since = until - timedelta(days=6)
        period = {
            "since": since.strftime("%Y-%m-%d"),
            "until": until.strftime("%Y-%m-%d"),
        }
        label = f"{since.strftime('%d.%m')}-{until.strftime('%d.%m')}"
        await q.edit_message_text(f"–ì–æ—Ç–æ–≤–ª—é –æ—Ç—á—ë—Ç –∑–∞ {label}‚Ä¶")
        await send_period_report(context, chat_id, period, label)
        return

    # ===== –¢–ï–ü–õ–û–í–ê–Ø –ö–ê–†–¢–ê =====
    if data == "hm_menu":
        await q.edit_message_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:",
            reply_markup=accounts_kb("hmacc"),
        )
        return

    if data.startswith("hmacc|"):
        aid = data.split("|", 1)[1]
        context.user_data["heatmap_aid"] = aid
        await q.edit_message_text(
            f"–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã –¥–ª—è {get_account_name(aid)}:",
            reply_markup=heatmap_menu(aid),
        )
        return

    if data.startswith("hm7|"):
        aid = data.split("|")[1]
        heat = build_heatmap_for_account(aid, get_account_name, mode="7")
        await q.edit_message_text(heat, parse_mode="HTML")
        return

    if data.startswith("hm14|"):
        aid = data.split("|")[1]
        heat = build_heatmap_for_account(aid, get_account_name, mode="14")
        await q.edit_message_text(heat, parse_mode="HTML")
        return

    if data.startswith("hmmonth|"):
        aid = data.split("|")[1]
        heat = build_heatmap_for_account(aid, get_account_name, mode="month")
        await q.edit_message_text(heat, parse_mode="HTML")
        return

    # ===== –ë–ò–õ–õ–ò–ù–ì =====
    if data == "billing":
        await q.edit_message_text(
            "–ß—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ –±–∏–ª–ª–∏–Ω–≥—É?", reply_markup=billing_menu()
        )
        return
    if data == "billing_current":
        await q.edit_message_text("üìã –ë–∏–ª–ª–∏–Ω–≥–∏ (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã):")
        await send_billing(context, chat_id)
        return
    if data == "billing_forecast":
        await q.edit_message_text("üîÆ –°—á–∏—Ç–∞—é –ø—Ä–æ–≥–Ω–æ–∑ —Å–ø–∏—Å–∞–Ω–∏–π‚Ä¶")
        await send_billing_forecast(context, chat_id)
        return

    # ===== –°–ò–ù–ö BM =====
    if data == "sync_bm":
        try:
            res = upsert_from_bm()
            last_sync_h = human_last_sync()
            await q.edit_message_text(
                f"‚úÖ –°–∏–Ω–∫ –∑–∞–≤–µ—Ä—à—ë–Ω. –î–æ–±–∞–≤–ª–µ–Ω–æ: {res['added']}, "
                f"–æ–±–Ω–æ–≤–ª–µ–Ω–æ: {res['updated']}, –ø—Ä–æ–ø—É—â–µ–Ω–æ: {res['skipped']}. "
                f"–í—Å–µ–≥–æ: {res['total']}\n"
                f"üïì –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: {last_sync_h}",
                reply_markup=main_menu(),
            )
        except Exception as e:
            await q.edit_message_text(
                f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω–∫–∞: {e}", reply_markup=main_menu()
            )
        return

    # ===== –û–¢–ß–Å–¢ –ü–û –ê–ö–ö–ê–£–ù–¢–£ (–ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ô) =====
    if data == "choose_acc_report":
        await q.edit_message_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç:", reply_markup=accounts_kb("rep_choose")
        )
        return

    if data.startswith("rep_choose|"):
        aid = data.split("|", 1)[1]
        await q.edit_message_text(
            f"–û—Ç—á—ë—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π:\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ –æ—Ç—á—ë—Ç–∞ –¥–ª—è {get_account_name(aid)}:",
            reply_markup=account_report_kind_kb(aid),
        )
        return

    if data.startswith("rep_adsets|"):
        aid = data.split("|", 1)[1]
        await q.edit_message_text(
            f"–ì–æ—Ç–æ–≤–ª—é –æ—Ç—á—ë—Ç –ø–æ –∞–¥—Å–µ—Ç–∞–º –¥–ª—è {get_account_name(aid)} "
            f"–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π‚Ä¶"
        )
        await send_adset_report(context, chat_id, aid)
        return

    if data.startswith("rep_acc|"):
        aid = data.split("|", 1)[1]
        await q.edit_message_text(
            f"–û—Ç—á—ë—Ç –ø–æ: {get_account_name(aid)}\n–í—ã–±–µ—Ä–∏ –ø–µ—Ä–∏–æ–¥:",
            reply_markup=period_kb_for(aid),
        )
        return

    if data.startswith("one_today|"):
        aid = data.split("|", 1)[1]
        label = datetime.now(ALMATY_TZ).strftime("%d.%m.%Y")
        await q.edit_message_text(
            f"–û—Ç—á—ë—Ç –ø–æ {get_account_name(aid)} –∑–∞ {label}:"
        )
        txt = get_cached_report(aid, "today", label)
        await context.bot.send_message(
            chat_id,
            txt or "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö/–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞.",
            parse_mode="HTML",
        )
        return

    if data.startswith("one_yday|"):
        aid = data.split("|", 1)[1]
        label = (datetime.now(ALMATY_TZ) - timedelta(days=1)).strftime("%d.%m.%Y")
        await q.edit_message_text(
            f"–û—Ç—á—ë—Ç –ø–æ {get_account_name(aid)} –∑–∞ {label}:"
        )
        txt = get_cached_report(aid, "yesterday", label)
        await context.bot.send_message(
            chat_id,
            txt or "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö/–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞.",
            parse_mode="HTML",
        )
        return

    if data.startswith("one_week|"):
        aid = data.split("|", 1)[1]
        until = datetime.now(ALMATY_TZ) - timedelta(days=1)
        since = until - timedelta(days=6)
        period = {
            "since": since.strftime("%Y-%m-%d"),
            "until": until.strftime("%Y-%m-%d"),
        }
        label = f"{since.strftime('%d.%m')}-{until.strftime('%d.%m')}"
        await q.edit_message_text(
            f"–û—Ç—á—ë—Ç –ø–æ {get_account_name(aid)} –∑–∞ {label}:"
        )
        txt = get_cached_report(aid, period, label)
        await context.bot.send_message(
            chat_id,
            txt or "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö/–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞.",
            parse_mode="HTML",
        )
        return

    if data.startswith("one_custom|"):
        aid = data.split("|", 1)[1]
        context.user_data["await_range_for"] = aid
        await q.edit_message_text(
            f"–í–≤–µ–¥–∏ –¥–∞—Ç—ã –¥–ª—è {get_account_name(aid)} —Ñ–æ—Ä–º–∞—Ç–æ–º: 01.06.2025-07.06.2025",
            reply_markup=period_kb_for(aid),
        )
        return

    # ===== –°–†–ê–í–ù–ï–ù–ò–ï –ü–ï–†–ò–û–î–û–í =====
    if data.startswith("cmp_menu|"):
        aid = data.split("|", 1)[1]
        await q.edit_message_text(
            f"–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤ –¥–ª—è {get_account_name(aid)}:",
            reply_markup=compare_kb_for(aid),
        )
        return

    if data.startswith("back_periods|"):
        aid = data.split("|", 1)[1]
        await q.edit_message_text(
            f"–û—Ç—á—ë—Ç –ø–æ: {get_account_name(aid)}\n–í—ã–±–µ—Ä–∏ –ø–µ—Ä–∏–æ–¥:",
            reply_markup=period_kb_for(aid),
        )
        return

    if data.startswith("cmp_week|"):
        aid = data.split("|", 1)[1]
        now = datetime.now(ALMATY_TZ)
        until2 = now - timedelta(days=1)
        since2 = until2 - timedelta(days=6)
        until1 = since2 - timedelta(days=1)
        since1 = until1 - timedelta(days=6)
        period1 = {
            "since": since1.strftime("%Y-%m-%d"),
            "until": until1.strftime("%Y-%m-%d"),
        }
        period2 = {
            "since": since2.strftime("%Y-%m-%d"),
            "until": until2.strftime("%Y-%m-%d"),
        }
        label1 = f"{since1.strftime('%d.%m')}-{until1.strftime('%d.%m')}"
        label2 = f"{since2.strftime('%d.%m')}-{until2.strftime('%d.%m')}"
        await q.edit_message_text(f"–°—Ä–∞–≤–Ω–∏–≤–∞—é {label1} vs {label2}‚Ä¶")
        txt = build_comparison_report(aid, period1, label1, period2, label2)
        await context.bot.send_message(chat_id, txt, parse_mode="HTML")
        return

    if data.startswith("cmp_custom|"):
        aid = data.split("|", 1)[1]
        context.user_data["await_cmp_for"] = aid
        await q.edit_message_text(
            "–û—Ç–ø—Ä–∞–≤—å –¥–≤–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç —á–µ—Ä–µ–∑ ';' –∏–ª–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
            "01.06.2025-07.06.2025;08.06.2025-14.06.2025",
            reply_markup=compare_kb_for(aid),
        )
        return

    # ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
    if data == "choose_acc_settings":
        await q.edit_message_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:",
            reply_markup=accounts_kb("set1"),
        )
        return

    if data.startswith("set1|"):
        aid = data.split("|", 1)[1]
        await q.edit_message_text(
            f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏: {get_account_name(aid)}",
            reply_markup=settings_kb(aid),
        )
        return

    if data.startswith("toggle_enabled|"):
        aid = data.split("|", 1)[1]
        st = load_accounts()
        row = st.get(aid, {})
        row["enabled"] = not row.get("enabled", True)
        st[aid] = row
        save_accounts(st)
        await q.edit_message_text(
            f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏: {get_account_name(aid)}",
            reply_markup=settings_kb(aid),
        )
        return

    if data.startswith("toggle_m|"):
        aid = data.split("|", 1)[1]
        st = load_accounts()
        row = st.get(aid, {"metrics": {}})
        row["metrics"] = row.get("metrics", {})
        row["metrics"]["messaging"] = not row["metrics"].get("messaging", True)
        st[aid] = row
        save_accounts(st)
        await q.edit_message_text(
            f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏: {get_account_name(aid)}",
            reply_markup=settings_kb(aid),
        )
        return

    if data.startswith("toggle_l|"):
        aid = data.split("|", 1)[1]
        st = load_accounts()
        row = st.get(aid, {"metrics": {}})
        row["metrics"] = row.get("metrics", {})
        row["metrics"]["leads"] = not row["metrics"].get("leads", False)
        st[aid] = row
        save_accounts(st)
        await q.edit_message_text(
            f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏: {get_account_name(aid)}",
            reply_markup=settings_kb(aid),
        )
        return

    if data.startswith("toggle_alert|"):
        aid = data.split("|", 1)[1]
        st = load_accounts()
        row = st.get(aid, {"alerts": {}})
        alerts = row.get("alerts", {})
        if alerts.get("enabled", False):
            alerts["enabled"] = False
        else:
            alerts["enabled"] = float(alerts.get("target_cpl", 0) or 0) > 0
        row["alerts"] = alerts
        st[aid] = row
        save_accounts(st)
        await q.edit_message_text(
            f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏: {get_account_name(aid)}",
            reply_markup=settings_kb(aid),
        )
        return

    if data.startswith("set_cpa|"):
        aid = data.split("|", 1)[1]
        st = load_accounts()
        row = st.get(aid, {"alerts": {}})
        alerts = row.get("alerts", {})
        current = float(alerts.get("target_cpl", 0.0) or 0.0)
        row["alerts"] = alerts
        st[aid] = row
        save_accounts(st)
        await q.edit_message_text(
            f"‚ö†Ô∏è –¢–µ–∫—É—â–∏–π target CPA: {current:.2f} $.\n"
            f"–ù–∞–ø–∏—à–∏ –≤ —á–∞—Ç —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä 2.5). 0 ‚Äî –≤—ã–∫–ª—é—á–∏—Ç –∞–ª–µ—Ä—Ç—ã.",
            reply_markup=settings_kb(aid),
        )
        context.user_data["await_cpa_for"] = aid
        return


# ============ TEXT INPUT ============
async def on_text_any(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not _allowed(update):
        return

    chat = update.effective_chat
    if chat and chat.type in ("group", "supergroup"):
        return

    text = update.message.text.strip()

    # –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
    if "await_range_for" in context.user_data:
        aid = context.user_data.pop("await_range_for")
        parsed = parse_range(text)
        if not parsed:
            await update.message.reply_text(
                "–§–æ—Ä–º–∞—Ç –¥–∞—Ç: 01.06.2025-07.06.2025. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑."
            )
            context.user_data["await_range_for"] = aid
            return
        period, label = parsed
        txt = get_cached_report(aid, period, label)
        await update.message.reply_text(
            txt or "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö/–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞.", parse_mode="HTML"
        )
        return

    # —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
    if "await_cmp_for" in context.user_data:
        aid = context.user_data.pop("await_cmp_for")
        parsed = parse_two_ranges(text)
        if not parsed:
            await update.message.reply_text(
                "–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç.\n"
                "–ü—Ä–∏–º–µ—Ä: 01.06.2025-07.06.2025;08.06.2025-14.06.2025"
            )
            return
        (p1, label1), (p2, label2) = parsed
        txt = build_comparison_report(aid, p1, label1, p2, label2)
        await update.message.reply_text(txt, parse_mode="HTML")
        return

    # –≤–≤–æ–¥ target CPA
    if "await_cpa_for" in context.user_data:
        aid = context.user_data.pop("await_cpa_for")
        try:
            val = float(text.replace(",", "."))
        except Exception:
            await update.message.reply_text(
                "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 2.5 (–∏–ª–∏ 0 —á—Ç–æ–±—ã –≤—ã–∫–ª—é—á–∏—Ç—å)"
            )
            context.user_data["await_cpa_for"] = aid
            return

        st = load_accounts()
        row = st.get(aid, {"alerts": {}})
        alerts = row.get("alerts", {})
        alerts["target_cpl"] = float(val)
        alerts["enabled"] = val > 0
        row["alerts"] = alerts
        st[aid] = row
        save_accounts(st)

        if val > 0:
            await update.message.reply_text(
                f"‚úÖ Target CPA –¥–ª—è {get_account_name(aid)} –æ–±–Ω–æ–≤–ª—ë–Ω: {val:.2f} $ (–∞–ª–µ—Ä—Ç—ã –í–ö–õ)"
            )
        else:
            await update.message.reply_text(
                f"‚úÖ Target CPA –¥–ª—è {get_account_name(aid)} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω 0 ‚Äî –∞–ª–µ—Ä—Ç—ã –í–´–ö–õ"
            )
        return

    # —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –¥–ª—è –∞–≤—Ç–æ–ø–∏–ª–∞—Ç–∞
    if "await_manual_input" in context.user_data:
        entity_id = context.user_data.pop("await_manual_input")
        percent = parse_manual_input(text)
        if percent is None:
            await update.message.reply_text(
                "‚ùå –ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å —á–∏—Å–ª–æ. –ü—Ä–∏–º–µ—Ä: 1.2, 20, -15",
                parse_mode="HTML"
            )
            context.user_data["await_manual_input"] = entity_id
            return

        await update.message.reply_text(
            f"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ –Ω–∞ <b>{percent:+.1f}%</b> "
            f"–¥–ª—è <code>{entity_id}</code>?",
            parse_mode="HTML",
            reply_markup=confirm_action_buttons(str(percent), entity_id)
        )
        return


# ============ APP ============
def build_app() -> Application:
    app = Application.builder().token(TELEGRAM_TOKEN).build()

    app.add_handler(CommandHandler("whoami", cmd_whoami))
    app.add_handler(CommandHandler("start", cmd_start))
    app.add_handler(CommandHandler("help", cmd_help))
    app.add_handler(CommandHandler("billing", cmd_billing))
    app.add_handler(CommandHandler("sync_accounts", cmd_sync))
    app.add_handler(CommandHandler("heatmap", cmd_heatmap))

    app.add_handler(CallbackQueryHandler(on_cb_autopilot, pattern="^ap"))
    app.add_handler(CallbackQueryHandler(on_cb))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, on_text_any))

    # –î–∂–æ–±—ã
    app.job_queue.run_daily(
        full_daily_scan_job,
        time=time(hour=9, minute=20, tzinfo=ALMATY_TZ),
    )

    app.job_queue.run_daily(
        daily_report_job,
        time=time(hour=9, minute=30, tzinfo=ALMATY_TZ),
    )

    app.job_queue.run_daily(
        billing_digest_job,
        time=time(hour=9, minute=0, tzinfo=ALMATY_TZ),
    )

    schedule_cpa_alerts(app)

    init_billing_watch(
        app,
        get_enabled_accounts=get_enabled_accounts_in_order,
        get_account_name=get_account_name,
        usd_to_kzt=usd_to_kzt,
        kzt_round_up_1000=kzt_round_up_1000,
        owner_id=253181449,
        group_chat_id=str(DEFAULT_REPORT_CHAT),
    )

    return app
